/**
 * 错误处理工具
 */

/**
 * 处理 Supabase 错误
 */
export function handleSupabaseError(error: any): string {
  if (!error) return '未知错误'

  // Supabase 错误码处理
  switch (error.code) {
    case 'PGRST116':
      return '数据不存在，请检查输入'
    case 'PGRST301':
      return '权限不足，请重新登录'
    case '23505':
      return '数据已存在，请勿重复提交'
    case '23503':
      return '数据关联错误，请检查相关数据'
    case '42501':
      return '权限不足，请联系管理员'
    case '28P01':
      return '服务器繁忙，请稍后重试'
    case 'auth/invalid_credentials':
      return '邮箱或密码错误'
    case 'auth/user_not_found':
      return '用户不存在'
    case 'auth/email_already_in_use':
      return '邮箱已被注册'
    case 'auth/weak_password':
      return '密码太简单，请设置更复杂的密码'
    case 'auth/too_many_requests':
      return '请求过于频繁，请稍后再试'
    case 'auth/session_expired':
      return '登录已过期，请重新登录'
    default:
      // 如果有消息字段，返回消息
      if (error.message) {
        return error.message
      }
      // 否则返回通用错误
      return '操作失败，请稍后重试'
  }
}

/**
 * 处理 API 错误
 */
export function handleApiError(error: any): string {
  if (!error) return '未知错误'

  if (error.response) {
    // HTTP 错误
    const status = error.response.status
    switch (status) {
      case 400:
        return '请求参数错误'
      case 401:
        return '未授权，请重新登录'
      case 403:
        return '权限不足'
      case 404:
        return '请求的资源不存在'
      case 422:
        return error.response.data?.message || '数据验证失败'
      case 429:
        return '请求过于频繁，请稍后再试'
      case 500:
        return '服务器内部错误'
      case 502:
        return '网关错误'
      case 503:
        return '服务暂时不可用'
      default:
        return `请求失败 (${status})`
    }
  } else if (error.request) {
    // 网络错误
    return '网络连接失败，请检查网络设置'
  } else {
    // 其他错误
    return error.message || '操作失败'
  }
}

/**
 * 格式化错误信息用于日志
 */
export function formatErrorForLog(error: any): string {
  if (!error) return 'No error'

  const parts = []

  if (error.name) parts.push(`Name: ${error.name}`)
  if (error.message) parts.push(`Message: ${error.message}`)
  if (error.code) parts.push(`Code: ${error.code}`)
  if (error.status) parts.push(`Status: ${error.status}`)
  if (error.details) parts.push(`Details: ${JSON.stringify(error.details)}`)
  if (error.hint) parts.push(`Hint: ${error.hint}`)

  return parts.join('\n')
}