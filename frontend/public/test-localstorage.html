<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocalStorage æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #ff2442;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      opacity: 0.9;
    }
    button.secondary {
      background: #666;
    }
    pre {
      background: #f8f8f8;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
    }
    .success {
      color: #52c41a;
      font-weight: bold;
    }
    .error {
      color: #ff4d4f;
      font-weight: bold;
    }
    .info {
      color: #1890ff;
    }
  </style>
</head>
<body>
  <h1>ğŸ” LocalStorage åŠŸèƒ½æµ‹è¯•</h1>
  
  <div class="card">
    <h2>1. åŸºç¡€æµ‹è¯•</h2>
    <button onclick="testBasic()">æµ‹è¯•åŸºç¡€è¯»å†™</button>
    <button onclick="testQuota()" class="secondary">æµ‹è¯•å­˜å‚¨å®¹é‡</button>
    <div id="basic-result"></div>
  </div>

  <div class="card">
    <h2>2. å†å²è®°å½•æµ‹è¯•</h2>
    <button onclick="createTestRecord()">åˆ›å»ºæµ‹è¯•è®°å½•</button>
    <button onclick="updateTestRecord()">æ›´æ–°æµ‹è¯•è®°å½•</button>
    <button onclick="viewRecords()">æŸ¥çœ‹æ‰€æœ‰è®°å½•</button>
    <button onclick="clearRecords()" class="secondary">æ¸…ç©ºè®°å½•</button>
    <div id="history-result"></div>
  </div>

  <div class="card">
    <h2>3. å½“å‰å­˜å‚¨çŠ¶æ€</h2>
    <button onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨</button>
    <div id="storage-info"></div>
  </div>

  <script>
    const HISTORY_KEY = 'redink-history';

    function log(elementId, message, type = 'info') {
      const el = document.getElementById(elementId);
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      el.innerHTML += `<p class="${className}">${message}</p>`;
    }

    function testBasic() {
      const result = document.getElementById('basic-result');
      result.innerHTML = '';
      
      try {
        // æµ‹è¯•å†™å…¥
        localStorage.setItem('test-key', 'test-value');
        log('basic-result', 'âœ… å†™å…¥æµ‹è¯•æˆåŠŸ', 'success');
        
        // æµ‹è¯•è¯»å–
        const value = localStorage.getItem('test-key');
        if (value === 'test-value') {
          log('basic-result', 'âœ… è¯»å–æµ‹è¯•æˆåŠŸ', 'success');
        } else {
          log('basic-result', 'âŒ è¯»å–æµ‹è¯•å¤±è´¥', 'error');
        }
        
        // æµ‹è¯•åˆ é™¤
        localStorage.removeItem('test-key');
        log('basic-result', 'âœ… åˆ é™¤æµ‹è¯•æˆåŠŸ', 'success');
        
        log('basic-result', '<strong>âœ… LocalStorage åŠŸèƒ½æ­£å¸¸</strong>', 'success');
      } catch (e) {
        log('basic-result', `âŒ æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function testQuota() {
      const result = document.getElementById('basic-result');
      result.innerHTML = '';
      
      try {
        let size = 0;
        const testData = 'x'.repeat(1024); // 1KB
        
        for (let i = 0; i < 10000; i++) {
          try {
            localStorage.setItem(`quota-test-${i}`, testData);
            size += testData.length;
          } catch (e) {
            log('basic-result', `âš ï¸ å­˜å‚¨ä¸Šé™: çº¦ ${(size / 1024 / 1024).toFixed(2)} MB`, 'info');
            break;
          }
        }
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        for (let i = 0; i < 10000; i++) {
          localStorage.removeItem(`quota-test-${i}`);
        }
        
        log('basic-result', 'âœ… å®¹é‡æµ‹è¯•å®Œæˆ', 'success');
      } catch (e) {
        log('basic-result', `âŒ æµ‹è¯•å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function createTestRecord() {
      const result = document.getElementById('history-result');
      result.innerHTML = '';
      
      try {
        const records = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        const newRecord = {
          id: Date.now().toString(),
          title: 'æµ‹è¯•è®°å½• ' + new Date().toLocaleTimeString(),
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString(),
          outline: {
            raw: 'æµ‹è¯•å¤§çº²å†…å®¹',
            pages: [
              { index: 0, type: 'cover', content: 'å°é¢å†…å®¹' },
              { index: 1, type: 'content', content: 'å†…å®¹é¡µ1' }
            ]
          },
          images: {
            task_id: 'task_' + Date.now(),
            generated: []
          },
          status: 'draft',
          thumbnail: null
        };
        
        records.unshift(newRecord);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(records));
        
        log('history-result', `âœ… åˆ›å»ºè®°å½•æˆåŠŸ: ${newRecord.id}`, 'success');
        log('history-result', `<pre>${JSON.stringify(newRecord, null, 2)}</pre>`);
      } catch (e) {
        log('history-result', `âŒ åˆ›å»ºå¤±è´¥: ${e.message}`, 'error');
      }
    }

    function updateTestRecord() {
      const result = document.getElementById('history-result');
      result.innerHTML = '';
      
      try {
        const records = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        if (records.length === 0) {
          log('history-result', 'âš ï¸ æ²¡æœ‰è®°å½•å¯æ›´æ–°ï¼Œè¯·å…ˆåˆ›å»ºè®°å½•', 'error');
          return;
        }
        
        // æ›´æ–°ç¬¬ä¸€æ¡è®°å½•
        records[0].images.generated = [
          'https://example.com/image1.png',
          'https://example.com/image2.png'
        ];
        records[0].status = 'completed';
        records[0].thumbnail = 'https://example.com/image1.png';
        records[0].updated_at = new Date().toISOString();
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(records));
        
        log('history-result', `âœ… æ›´æ–°è®°å½•æˆåŠŸ: ${records[0].id}`, 'success');
        log('history-result', `<pre>${JSON.stringify(records[0], null, 2)}</pre>`);
      } catch (e) {
        log('history-result', `âŒ æ›´æ–°å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function viewRecords() {
      const result = document.getElementById('history-result');
      result.innerHTML = '';
      
      try {
        const records = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        
        log('history-result', `ğŸ“Š å…±æœ‰ ${records.length} æ¡è®°å½•`, 'info');
        
        if (records.length > 0) {
          log('history-result', `<pre>${JSON.stringify(records, null, 2)}</pre>`);
        } else {
          log('history-result', 'æš‚æ— è®°å½•');
        }
      } catch (e) {
        log('history-result', `âŒ è¯»å–å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function clearRecords() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
        localStorage.removeItem(HISTORY_KEY);
        document.getElementById('history-result').innerHTML = '<p class="success">âœ… å·²æ¸…ç©ºæ‰€æœ‰è®°å½•</p>';
      }
    }

    function checkStorage() {
      const result = document.getElementById('storage-info');
      result.innerHTML = '';
      
      try {
        let totalSize = 0;
        let itemCount = 0;
        const items = [];
        
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          const value = localStorage.getItem(key);
          const size = (key.length + value.length) * 2; // UTF-16
          
          totalSize += size;
          itemCount++;
          items.push({ key, size: (size / 1024).toFixed(2) + ' KB' });
        }
        
        log('storage-info', `ğŸ“¦ å­˜å‚¨é¡¹æ•°é‡: ${itemCount}`, 'info');
        log('storage-info', `ğŸ’¾ æ€»å¤§å°: ${(totalSize / 1024).toFixed(2)} KB (${(totalSize / 1024 / 1024).toFixed(2)} MB)`, 'info');
        log('storage-info', `<pre>${JSON.stringify(items, null, 2)}</pre>`);
        
        // æ£€æŸ¥å†å²è®°å½•
        const historyData = localStorage.getItem(HISTORY_KEY);
        if (historyData) {
          const records = JSON.parse(historyData);
          log('storage-info', `ğŸ“ å†å²è®°å½•: ${records.length} æ¡`, 'success');
        } else {
          log('storage-info', 'ğŸ“ å†å²è®°å½•: 0 æ¡', 'info');
        }
      } catch (e) {
        log('storage-info', `âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`, 'error');
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = function() {
      checkStorage();
    };
  </script>
</body>
</html>
